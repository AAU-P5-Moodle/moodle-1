{"version":3,"file":"import_question.min.js","sources":["../src/import_question.js"],"sourcesContent":["import Templates from \"core/templates\";\nimport { exception as displayException } from \"core/notification\";\nimport { add_cancel_edit_button_listener, rerender_saved_questions_list } from \"./edit_question_helper\";\nimport { add_edit_question_listeners } from \"./edit_question\";\nimport { add_delete_question_listeners } from \"./delete_question\";\nimport { external_reuse_questions, get_lecturer_quiz } from \"./repository\";\nimport { rerender_take_quiz_button } from \"./edit_question_helper\";\n\n/**\n * Adds an event listener to the \"Import Question\" button.\n * When the button is clicked, it renders the import question menu popup.\n *\n * @param {number} quizId - The ID of the quiz.\n * @param {number} lecturerId - The ID of the lecturer.\n * @param {string} url - The URL to the quiz attempt page.\n * @returns {Promise<void>} A promise that resolves when the initialization is complete.\n */\nexport const init = async (quizId, lecturerId, url) => {\n    let importQuestionButton = document.getElementById(\"id_buttonimportquestion\");\n    importQuestionButton.addEventListener(\"click\", () => {\n        renderImportQuestionMenuPopup(quizId, lecturerId, url);\n    });\n};\n\n/**\n * Renders the import question menu popup for a live quiz.\n *\n * This function loads and renders the import question menu popup template, appends it to the main container,\n * Sets up event listeners for importing questions and cancelling the import.\n *\n * @param {number} quizId - The ID of the quiz.\n * @param {number} lecturerId - The ID of the lecturer.\n * @param {string} url - The URL to the quiz attempt page.\n * @returns {void} - Nothing.\n */\nfunction renderImportQuestionMenuPopup(quizId, lecturerId, url) {\n    // This will call the function to load and render our template.\n    if (!document.querySelector(\".Modal_div\")) {\n        Templates.renderForPromise(\"mod_livequiz/import_question_popup\")\n            // It returns a promise that needs to be resolved.\n            .then(({ html, js }) => {\n                // Here we have compiled template.\n                Templates.appendNodeContents(\".main-container\", html, js);\n                importQuestions(quizId, url, lecturerId);\n                add_cancel_edit_button_listener(\"import\");\n                addOldQuestionsToPopup(lecturerId, quizId);\n            })\n\n            // Deal with this exception (Using core/notify exception function is recommended).\n            .catch((error) => displayException(error));\n    }\n}\n\n/**\n * Adds old questions to the import question popup.\n * @param {number} lecturerId - The ID of the lecturer.\n * @param {number} quizId - The ID of the quiz.\n */\nfunction addOldQuestionsToPopup(lecturerId, quizId) {\n    get_lecturer_quiz(lecturerId)\n        .then((oldQuizzes) => {\n            // Filter out the current quiz, so you can't import questions from the same quiz.\n            oldQuizzes = oldQuizzes.filter((currentquiz) => currentquiz.quizid !== quizId);\n\n            // Check how many questions are available.\n            let oldQuizzesContainer = document.querySelector(\".oldQuizzes\");\n            if (oldQuizzes.length === 0) {\n                let noQuestions = document.createElement(\"p\");\n                noQuestions.textContent = \"No questions available.\";\n                oldQuizzesContainer.appendChild(noQuestions);\n                return;\n            }\n\n            //Otherwise, loop through all quizzes and add the questions to the popup.\n            oldQuizzes.forEach((quiz) => {\n                let quiz_context = {\n                    quizid: quiz.quizid,\n                    quiztitle: quiz.quiztitle,\n                    questions: quiz.questions,\n                };\n                if (quiz.questions.length > 0) {\n                    Templates.renderForPromise(\"mod_livequiz/import_questions_list\", quiz_context)\n                        .then(({ html, js }) => {\n                            Templates.appendNodeContents(\".oldQuizzes\", html, js);\n                            addQuizCheckboxListener(quiz.quizid);\n                            addQuestionCheckboxListener(quiz.quizid);\n                        })\n                        .catch((error) => displayException(error));\n                }\n            });\n        })\n        .catch((error) => displayException(error));\n}\n\n/**\n * Imports questions into a quiz.\n *\n * @param {number} quizId - The ID of the quiz.\n * @param {string} url - The URL of the quiz page.\n * @param {number} lecturerId - The ID of the lecturer.\n * @returns {Promise<void>} A promise that resolves when the questions are imported.\n */\nfunction importQuestions(quizId, url, lecturerId) {\n    let quizUrl = url;\n    const importQuestionBtn = document.querySelector(\".import_btn\");\n\n    importQuestionBtn.addEventListener(\"click\", async () => {\n        try {\n            let questionIds = getCheckedQuestions();\n            if (questionIds.length === 0) {\n                alert(\"No questions selected. Please choose at least one question to import.\");\n                return;\n            }\n            call_reuse_questions(quizId, questionIds, lecturerId, quizUrl);\n        } catch (error) {\n            displayException(error);\n        }\n    });\n}\n\n/**\n * Calls the external function to reuse questions.\n * @param {number} quizId - The ID of the quiz.\n * @param {array} questionIds - The IDs of the questions to reuse.\n * @param {number} lecturerId - The ID of the lecturer.\n * @param {string} quizUrl - The URL of the quiz page.\n */\nfunction call_reuse_questions(quizId, questionIds, lecturerId, quizUrl) {\n    external_reuse_questions(quizId, questionIds, lecturerId)\n        .then((questions) => {\n            let update_event_listeners = () => {\n                add_edit_question_listeners(quizId, lecturerId);\n                add_delete_question_listeners(quizId, lecturerId);\n            };\n            rerender_saved_questions_list(questions, update_event_listeners); // Re-render saved questions list.\n            rerender_take_quiz_button(quizUrl, true); // Re-render take quiz button.\n        })\n        .catch((error) => displayException(error));\n    let popupMenu = document.querySelector(\".backdrop\");\n    popupMenu.remove();\n}\n\n/**\n * Retrieves the values of all checked questions from the lecturer's question list.\n *\n * @returns {Array<number>} An array containing the ids of the checked questions.\n */\nfunction getCheckedQuestions() {\n    let checkedquestions = [];\n    let questions = document.querySelectorAll(\".question\");\n    questions.forEach((question) => {\n        if (question.checked) {\n            // If the checkbox is checked, add the id to the array.\n            checkedquestions.push(parseInt(question.id));\n        }\n    });\n\n    return checkedquestions; // Returns the checked questions.\n}\n\n/**\n * Adds an event listener to the quiz checkboxes.\n * Marks all questions as checked if the quiz checkbox is checked\n * @param {number} quizId - The ID of the quiz, used to identify the checkboxes.\n */\nfunction addQuizCheckboxListener(quizId) {\n    let quizCheckbox = document.querySelector(\".quiz_\" + quizId);\n    let questionCheckboxes = document.querySelectorAll(\".quiz_\" + quizId + \"_question\");\n\n    quizCheckbox.addEventListener(\"change\", () => {\n        questionCheckboxes.forEach((questionCheckbox) => {\n            questionCheckbox.checked = quizCheckbox.checked; // Set all questions to checked if the quiz is checked.\n        });\n    });\n}\n\n/**\n * Adds an event listener to the question checkboxes.\n * If all questions are checked, the quiz checkbox is checked.\n * If a question is unchecked, the quiz checkbox is unchecked.\n * @param {number} quizId - The ID of the quiz, used to identify the checkboxes.\n */\nfunction addQuestionCheckboxListener(quizId) {\n    let quizCheckbox = document.querySelector(\".quiz_\" + quizId);\n    let questionCheckboxes = document.querySelectorAll(\".quiz_\" + quizId + \"_question\");\n\n    questionCheckboxes.forEach((questionCheckbox) => {\n        questionCheckbox.addEventListener(\"change\", () => {\n            if (questionCheckbox.checked) {\n                // If the question is checked, check if all questions are checked.\n                let allChecked = false;\n                allChecked = areAllQuestionsChecked(questionCheckboxes);\n                if (allChecked) {\n                    // If all questions are checked, check the quiz checkbox.\n                    quizCheckbox.checked = questionCheckbox.checked;\n                }\n            } else {\n                // If the question is unchecked, uncheck the quiz checkbox.\n                quizCheckbox.checked = questionCheckbox.checked;\n            }\n        });\n    });\n}\n\n/**\n * Checks if all questions are checked.\n * @param {NodeList} questions\n * @returns {bool} - True if all questions are checked, false otherwise.\n */\nfunction areAllQuestionsChecked(questions) {\n    //Convert the NodeList to an array in order to use every function.\n    return Array.from(questions).every((question) => question.checked); // Returns true only if all are checked\n}\n"],"names":["async","quizId","lecturerId","url","document","getElementById","addEventListener","querySelector","renderForPromise","then","_ref","html","js","appendNodeContents","quizUrl","questionIds","checkedquestions","querySelectorAll","forEach","question","checked","push","parseInt","id","getCheckedQuestions","length","alert","questions","update_event_listeners","catch","error","remove","call_reuse_questions","importQuestions","oldQuizzes","filter","currentquiz","quizid","oldQuizzesContainer","noQuestions","createElement","textContent","appendChild","quiz","quiz_context","quiztitle","_ref2","quizCheckbox","questionCheckboxes","questionCheckbox","addQuizCheckboxListener","allChecked","Array","from","every","addQuestionCheckboxListener","addOldQuestionsToPopup","renderImportQuestionMenuPopup"],"mappings":"qbAiBoBA,MAAOC,OAAQC,WAAYC,OAChBC,SAASC,eAAe,2BAC9BC,iBAAiB,SAAS,eAgBZL,OAAQC,WAAYC,KAElDC,SAASG,cAAc,kCACdC,iBAAiB,sCAEtBC,MAAKC,WAACC,KAAEA,KAAFC,GAAQA,4BAEDC,mBAAmB,kBAAmBF,KAAMC,aA4D7CX,OAAQE,IAAKD,gBAC9BY,QAAUX,IACYC,SAASG,cAAc,eAE/BD,iBAAiB,SAASN,kBAEhCe,2BAwCRC,iBAAmB,UACPZ,SAASa,iBAAiB,aAChCC,SAASC,WACXA,SAASC,SAETJ,iBAAiBK,KAAKC,SAASH,SAASI,QAIzCP,iBAjDmBQ,MACS,IAAvBT,YAAYU,mBACZC,MAAM,mFAiBQzB,OAAQc,YAAab,WAAYY,kDAClCb,OAAQc,YAAab,YACzCO,MAAMkB,gBACCC,uBAAyB,oDACG3B,OAAQC,+DACND,OAAQC,qEAEZyB,UAAWC,4EACfd,SAAS,MAEtCe,OAAOC,QAAU,2BAAiBA,SACvB1B,SAASG,cAAc,aAC7BwB,SA1BFC,CAAqB/B,OAAQc,YAAab,WAAYY,SACxD,MAAOgB,mCACYA,WAxEbG,CAAgBhC,OAAQE,IAAKD,sEACG,mBAchBA,WAAYD,0CACtBC,YACbO,MAAMyB,aAEHA,WAAaA,WAAWC,QAAQC,aAAgBA,YAAYC,SAAWpC,aAGnEqC,oBAAsBlC,SAASG,cAAc,kBACvB,IAAtB2B,WAAWT,OAAc,KACrBc,YAAcnC,SAASoC,cAAc,YACzCD,YAAYE,YAAc,+BAC1BH,oBAAoBI,YAAYH,aAKpCL,WAAWhB,SAASyB,WACZC,aAAe,CACfP,OAAQM,KAAKN,OACbQ,UAAWF,KAAKE,UAChBlB,UAAWgB,KAAKhB,WAEhBgB,KAAKhB,UAAUF,OAAS,sBACdjB,iBAAiB,qCAAsCoC,cAC5DnC,MAAKqC,YAACnC,KAAEA,KAAFC,GAAQA,6BACDC,mBAAmB,cAAeF,KAAMC,aAkF7CX,YACzB8C,aAAe3C,SAASG,cAAc,SAAWN,QACjD+C,mBAAqB5C,SAASa,iBAAiB,SAAWhB,OAAS,aAEvE8C,aAAazC,iBAAiB,UAAU,KACpC0C,mBAAmB9B,SAAS+B,mBACxBA,iBAAiB7B,QAAU2B,aAAa3B,cAvFxB8B,CAAwBP,KAAKN,iBAkGpBpC,YAC7B8C,aAAe3C,SAASG,cAAc,SAAWN,QACjD+C,mBAAqB5C,SAASa,iBAAiB,SAAWhB,OAAS,aAEvE+C,mBAAmB9B,SAAS+B,mBACxBA,iBAAiB3C,iBAAiB,UAAU,QACpC2C,iBAAiB7B,QAAS,KAEtB+B,YAAa,EAmBDxB,UAlBoBqB,mBAApCG,WAoBLC,MAAMC,KAAK1B,WAAW2B,OAAOnC,UAAaA,SAASC,UAnB1C+B,aAEAJ,aAAa3B,QAAU6B,iBAAiB7B,cAI5C2B,aAAa3B,QAAU6B,iBAAiB7B,YAWxBO,gBA5HJ4B,CAA4BZ,KAAKN,WAEpCR,OAAOC,QAAU,2BAAiBA,eAIlDD,OAAOC,QAAU,2BAAiBA,SA9C3B0B,CAAuBtD,WAAYD,WAItC4B,OAAOC,QAAU,2BAAiBA,SA7BvC2B,CAA8BxD,OAAQC,WAAYC"}