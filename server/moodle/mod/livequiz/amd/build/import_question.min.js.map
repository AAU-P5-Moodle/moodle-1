{"version":3,"file":"import_question.min.js","sources":["../src/import_question.js"],"sourcesContent":["import Templates from \"core/templates\";\r\nimport { exception as displayException } from \"core/notification\";\r\nimport {addCancelEditButtonListener, rerenderSavedQuestionsList, rerenderTakeQuizButton} from \"./helper\";\r\nimport {addEditQuestionListeners} from \"./edit_question\";\r\nimport {addDeleteQuestionListeners} from \"./delete_question\";\r\nimport {externalReuseQuestions, getLecturerQuiz} from \"./repository\";\r\n\r\n/**\r\n * Adds an event listener to the \"Import Question\" button.\r\n * When the button is clicked, it renders the import question menu popup.\r\n *\r\n * @param {number} quizId - The ID of the quiz.\r\n * @param {number} lecturerId - The ID of the lecturer.\r\n * @param {string} url - The URL to the quiz attempt page.\r\n * @returns {Promise<void>} A promise that resolves when the initialization is complete.\r\n */\r\nexport const init = async(quizId, lecturerId, url) => {\r\n    let importQuestionButton = document.getElementById(\"import_question_button\");\r\n    importQuestionButton.addEventListener(\"click\", () => {\r\n        renderImportQuestionMenuPopup(quizId, lecturerId, url);\r\n    });\r\n};\r\n\r\n/**\r\n * Renders the import question menu popup for a live quiz.\r\n *\r\n * This function loads and renders the import question menu popup template, appends it to the main container,\r\n * Sets up event listeners for importing questions and cancelling the import.\r\n *\r\n * @param {number} quizId - The ID of the quiz.\r\n * @param {number} lecturerId - The ID of the lecturer.\r\n * @param {string} url - The URL to the quiz attempt page.\r\n * @returns {void} - Nothing.\r\n */\r\nfunction renderImportQuestionMenuPopup(quizId, lecturerId, url) {\r\n    // This will call the function to load and render our template.\r\n    if (!document.querySelector(\".modal_div\")) {\r\n        Templates.renderForPromise(\"mod_livequiz/import_question_popup\", {}, \"boost\")\r\n            // It returns a promise that needs to be resolved.\r\n            .then(({ html, js }) => {\r\n                // Here we have compiled template.\r\n                Templates.appendNodeContents(\".main_container\", html, js);\r\n                importQuestions(quizId, url, lecturerId);\r\n                addCancelEditButtonListener(\"import\");\r\n                addOldQuestionsToPopup(lecturerId, quizId);\r\n            })\r\n\r\n            // Deal with this exception (Using core/notify exception function is recommended).\r\n            .catch((error) => displayException(error));\r\n    }\r\n}\r\n\r\n/**\r\n * Adds old questions to the import question popup.\r\n *\r\n * @param {number} lecturerId - The ID of the lecturer.\r\n * @param {number} quizId - The ID of the quiz.\r\n * @returns {void}\r\n */\r\nfunction addOldQuestionsToPopup(lecturerId, quizId) {\r\n    getLecturerQuiz(lecturerId)\r\n        .then((oldQuizzes) => {\r\n            // Filter out the current quiz, so you can't import questions from the same quiz.\r\n            oldQuizzes = oldQuizzes.filter((currentquiz) => currentquiz.quizid !== quizId);\r\n\r\n            // Check how many questions are available.\r\n            let oldQuizzesContainer = document.querySelector(\".old_quizzes\");\r\n            if (oldQuizzes.length === 0) {\r\n                let noQuestions = document.createElement(\"p\");\r\n                noQuestions.textContent = \"No questions available.\";\r\n                oldQuizzesContainer.appendChild(noQuestions);\r\n                return;\r\n            }\r\n\r\n            //Otherwise, loop through all quizzes and add the questions to the popup.\r\n            oldQuizzes.forEach((quiz) => {\r\n                let quiz_context = {\r\n                    quizid: quiz.quizid,\r\n                    quiztitle: quiz.quiztitle,\r\n                    questions: quiz.questions,\r\n                };\r\n                if (quiz.questions.length > 0) {\r\n                    Templates.renderForPromise(\"mod_livequiz/import_questions_list\", quiz_context)\r\n                        .then(({ html, js }) => {\r\n                            Templates.appendNodeContents(\".old_quizzes\", html, js);\r\n                            addQuizCheckboxListener(quiz.quizid);\r\n                            addQuestionCheckboxListener(quiz.quizid);\r\n                            addQuestionEntryListeners(quiz.quizid);\r\n                        })\r\n                        .catch((error) => displayException(error));\r\n                }\r\n            });\r\n        })\r\n        .catch((error) => displayException(error));\r\n}\r\n\r\n/**\r\n * Imports questions into a quiz.\r\n *\r\n * @param {number} quizId - The ID of the quiz.\r\n * @param {number} quizId - The ID of the quiz.\r\n * @param {string} url - The URL of the quiz page.\r\n * @param {number} lecturerId - The ID of the lecturer.\r\n * @param {number} lecturerId - The ID of the lecturer.\r\n * @returns {Promise<void>} A promise that resolves when the questions are imported.\r\n */\r\nasync function importQuestions(quizId, url, lecturerId) {\r\n    let quizUrl = url;\r\n    const importQuestionBtn = document.querySelector(\".import_question_button\");\r\n\r\n    importQuestionBtn.addEventListener(\"click\", async () => {\r\n        try {\r\n            let questionIds = getCheckedQuestions();\r\n            if (questionIds.length === 0) {\r\n                alert(\"No questions selected. Please choose at least one question to import.\");\r\n                return;\r\n            }\r\n            callReuseQuestions(quizId, questionIds, lecturerId, quizUrl);\r\n        } catch (error) {\r\n            displayException(error);\r\n        }\r\n    });\r\n}\r\n\r\n/**\r\n * Calls the external function to reuse questions.\r\n *\r\n @param {number} quizId - The ID of the quiz.\r\n @param {Array<number>} questionIds - The IDs of the questions to reuse.\r\n @param {number} lecturerId - The ID of the lecturer.\r\n @param {string} quizUrl - The URL of the quiz page.\r\n @returns {void}\r\n */\r\nfunction callReuseQuestions(quizId, questionIds, lecturerId, quizUrl) {\r\n    externalReuseQuestions(quizId, questionIds, lecturerId)\r\n        .then((questions) => {\r\n            let updateEventListeners = () => {\r\n                addEditQuestionListeners(quizId, lecturerId);\r\n                addDeleteQuestionListeners(quizId, lecturerId);\r\n            };\r\n            rerenderSavedQuestionsList(questions, updateEventListeners); // Re-render saved questions list.\r\n            // Re-render take quiz button. Since at least one question was imported, hasquestions is true.\r\n            rerenderTakeQuizButton(quizUrl, true);\r\n        })\r\n        .catch((error) => displayException(error));\r\n    let popupMenu = document.querySelector(\".backdrop\");\r\n    popupMenu.remove();\r\n}\r\n\r\n/**\r\n * Retrieves the values of all checked questions from the lecturer's question list.\r\n *\r\n * @returns {Array<number>} An array containing the ids of the checked questions.\r\n */\r\nfunction getCheckedQuestions() {\r\n    let checkedquestions = [];\r\n    let questions = document.querySelectorAll(\".question_checkbox\");\r\n    questions.forEach((question) => {\r\n        if (question.checked) {\r\n            // If the checkbox is checked, add the id to the array.\r\n            checkedquestions.push(parseInt(question.id));\r\n        }\r\n    });\r\n\r\n    return checkedquestions; // Returns the checked questions.\r\n}\r\n\r\n/**\r\n * Adds an event listener to the quiz checkboxes.\r\n * Marks all questions as checked if the quiz checkbox is checked\r\n * @param {number} quizId - The ID of the quiz, used to identify the checkboxes.\r\n */\r\nfunction addQuizCheckboxListener(quizId) {\r\n    let quizCheckbox = document.querySelector(\".quiz_\" + quizId);\r\n    let questionCheckboxes = document.querySelectorAll(\".quiz_\" + quizId + \"_question\");\r\n\r\n    quizCheckbox.addEventListener(\"change\", () => {\r\n        questionCheckboxes.forEach((questionCheckbox) => {\r\n            questionCheckbox.checked = quizCheckbox.checked; // Set all questions to checked if the quiz is checked.\r\n            if (questionCheckbox.checked) {\r\n                let questionEntry = questionCheckbox.parentElement;\r\n                questionEntry.classList.add(\"question_selected\");\r\n            } else {\r\n                let questionEntry = questionCheckbox.parentElement;\r\n                questionEntry.classList.remove(\"question_selected\");\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Adds an event listener to the question checkboxes.\r\n * If all questions are checked, the quiz checkbox is checked.\r\n * If a question is unchecked, the quiz checkbox is unchecked.\r\n * @param {number} quizId - The ID of the quiz, used to identify the checkboxes.\r\n */\r\nfunction addQuestionCheckboxListener(quizId) {\r\n    let quizCheckbox = document.querySelector(\".quiz_\" + quizId);\r\n    let questionCheckboxes = document.querySelectorAll(\".quiz_\" + quizId + \"_question\");\r\n\r\n    questionCheckboxes.forEach((questionCheckbox) => {\r\n        questionCheckbox.addEventListener(\"click\", (event) => {\r\n            questionCheckbox.checked = !questionCheckbox.checked;\r\n        });\r\n\r\n        questionCheckbox.addEventListener(\"change\", () => {\r\n            let questionEntry = questionCheckbox.parentElement;\r\n\r\n            if (questionCheckbox.checked) {\r\n                questionEntry.classList.add(\"question_selected\");\r\n                // If the question is checked, check if all questions are checked.\r\n                let allChecked = false;\r\n                allChecked = areAllQuestionsChecked(questionCheckboxes);\r\n                if (allChecked) {\r\n                    // If all questions are checked, check the quiz checkbox.\r\n                    quizCheckbox.checked = true;\r\n                }\r\n            } else {\r\n                // If the question is unchecked, uncheck the quiz checkbox.\r\n                questionEntry.classList.remove(\"question_selected\");\r\n                quizCheckbox.checked = false;\r\n            }\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Adds an event listener to the question entries.\r\n * If a question entry is clicked, the checkbox is checked.\r\n * @param {number} quizId - The ID of the quiz, used to identify the checkboxes.\r\n */\r\nfunction addQuestionEntryListeners(quizId) {\r\n    let questionEntries = document.querySelectorAll(\".question_entry_\" + quizId);\r\n    questionEntries.forEach((questionEntry) => {\r\n        questionEntry.addEventListener(\"click\", () => {\r\n            let questionCheckbox = questionEntry.querySelector(\".question_checkbox\");\r\n            questionCheckbox.checked = !questionCheckbox.checked;\r\n            questionCheckbox.dispatchEvent(new Event(\"change\"));\r\n        });\r\n    });\r\n}\r\n\r\n/**\r\n * Checks if all questions are checked.\r\n * @param {NodeList} questions\r\n * @returns {bool} - True if all questions are checked, false otherwise.\r\n */\r\nfunction areAllQuestionsChecked(questions) {\r\n    //Convert the NodeList to an array in order to use every function.\r\n    return Array.from(questions).every((question) => question.checked); // Returns true only if all are checked\r\n}\r\n"],"names":["async","quizId","lecturerId","url","document","getElementById","addEventListener","querySelector","renderForPromise","then","_ref","html","js","appendNodeContents","quizUrl","questionIds","checkedquestions","querySelectorAll","forEach","question","checked","push","parseInt","id","getCheckedQuestions","length","alert","questions","updateEventListeners","catch","error","remove","callReuseQuestions","importQuestions","oldQuizzes","filter","currentquiz","quizid","oldQuizzesContainer","noQuestions","createElement","textContent","appendChild","quiz","quiz_context","quiztitle","_ref2","quizCheckbox","questionCheckboxes","questionCheckbox","parentElement","classList","add","addQuizCheckboxListener","event","questionEntry","allChecked","Array","from","every","addQuestionCheckboxListener","dispatchEvent","Event","addQuestionEntryListeners","addOldQuestionsToPopup","renderImportQuestionMenuPopup"],"mappings":"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"}